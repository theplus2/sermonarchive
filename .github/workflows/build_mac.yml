name: Build macOS DMG

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_mac:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pyinstaller

    - name: Install create-dmg
      run: |
        brew install create-dmg

    - name: Build with PyInstaller
      run: |
        # build.py handles the build process and cleaning
        python build.py
        
        # Verify output
        echo "Listing dist directory:"
        ls -F dist/

    - name: Create DMG
      run: |
        # Define variables
        VOL_NAME="SermonLibrary_v5.1.2"
        DMG_NAME="SermonLibrary_v5.1.2_Installer.dmg"
        APP_NAME="설교자의서재v5.1.2.app"
        
        # Check if .app exists
        if [ ! -d "dist/$APP_NAME" ]; then
          echo "Error: dist/$APP_NAME not found!"
          exit 1
        fi

        # Make sure dist directory is clean for dmg creation
        # (create-dmg creates the dmg in the current directory or specified path)
        
        # Create DMG using create-dmg utility
        # Note: icon.icns is in the root directory
        create-dmg \
          --volname "$VOL_NAME" \
          --volicon "icon.icns" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "$APP_NAME" 200 190 \
          --hide-extension "$APP_NAME" \
          --app-drop-link 600 185 \
          "dist/$DMG_NAME" \
          "dist/$APP_NAME"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SermonArchive-macOS-v5.1.2
        path: dist/*.dmg
